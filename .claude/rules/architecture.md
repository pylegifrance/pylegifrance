# Architecture

## Package Structure

```
pylegifrance/
  __init__.py          # Public API: LegifranceClient, ApiConfig
  auth.py              # OAuth token management
  client.py            # LegifranceClient (requests.Session, call_api, get, ping)
  config.py            # ApiConfig (from_env)
  utils.py             # Session timeout helpers
  models/
    base.py            # PyLegifranceBaseModel (Pydantic v2, camelCase aliases)
    constants.py       # Shared enums (Fond, TypeRecherche, Operateur, etc.)
    identifier.py      # ID helpers
    generated/
      model.py         # AUTO-GENERATED — DO NOT EDIT (see below)
    code/              # Code-specific domain models
      enum.py          # NomCode, TypeChampCode, SortCode
      search.py        # Search request/criteria/filters
      consult.py       # Consult request models
      models.py        # Article, Code result models
    juri/              # Jurisprudence domain models
    loda/              # Lois et décrets domain models
  fonds/
    code.py            # Code facade (CodeSearchBuilder, CodeConsultFetcher, ArticleFetcher)
    juri.py            # Juri facade
    loda.py            # Loda facade
```

## Generated Models

`pylegifrance/models/generated/model.py` is auto-generated by `datamodel-codegen`.

**DO NOT edit this file manually.** To regenerate:

```bash
uv run datamodel-codegen \
  --input pylegifrance/models/generated/legifrance.json \
  --output pylegifrance/models/generated/model.py
```

Configuration is in `pyproject.toml` under `[tool.datamodel-codegen]`.

## Builder Pattern

Each fond facade exposes builders for fluent API construction:

- `CodeSearchBuilder` — `.in_code()` → `.text()` → `.at_date()` → `.execute()`
- `CodeConsultFetcher` — `.include_abrogated()` → `.section()` → `.at(date)`
- `ArticleFetcher` — `.at(date)`

Builders return `Self` for chaining and take `LegifranceClient` as first argument.

## API Client

- **Factory**: `LegifranceClient.create(config)` or `LegifranceClient(config)`.
- **Context manager**: `client.session_context()` ensures session cleanup.
- **Auth**: Handled transparently by `AuthenticationManager`; tokens are refreshed on each `call_api`/`get`.

## Fond Facade Pattern

Each fond (Code, Juri, Loda) has a facade class in `pylegifrance/fonds/` that:

1. Takes a `LegifranceClient` and optional `fond` string.
2. Exposes `.search()` returning a builder.
3. Exposes `.fetch_*()` methods returning fetcher objects.

## Enum Wrapping

Domain enums in `models/<fond>/enum.py` wrap generated DTO enums. Conversion is done via `to_generated()` on domain models before API calls. This isolates the public API from generated code changes.
